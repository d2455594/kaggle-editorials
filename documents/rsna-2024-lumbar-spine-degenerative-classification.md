---
tags:
  - Kaggle
  - 物体検出
  - セグメンテーション
  - 画像認識処理
startdate: 2024-05-17
enddate: 2024-10-09
---
# RSNA 2024 Lumbar Spine Degenerative Classification
https://www.kaggle.com/competitions/rsna-2024-lumbar-spine-degenerative-classification

**概要 (Overview)**

* **目的:** このコンペティションの目的は、腰椎（Lumbar Spine）の医用画像（主にMRIと推測される）を分析し、複数の変性疾患（例: 脊柱管狭窄症、椎間板ヘルニア、すべり症など）の有無や重症度を自動的に分類する機械学習モデルを開発することです。
* **背景:** 腰椎の変性疾患は腰痛や身体機能障害の一般的な原因であり、その診断と評価には放射線科医による医用画像の読影が不可欠です。しかし、読影には専門知識が必要で時間がかかり、評価者間でのばらつきも生じ得ます。自動分類モデルは、放射線科医の診断支援、診断の一貫性向上、レポート作成の迅速化などに貢献することが期待されます。RSNA（北米放射線学会）は、医療AIの進歩を目的としたコンペティションを定期的に開催しています。
* **課題:** 複雑な医用画像（特にMRIのような3次元データ）から、変性所見の微妙な兆候を正確に捉えること。画質、患者の解剖学的構造、疾患の多様性などに対応すること。多くの場合、特定の椎骨レベル（例: L3/L4, L4/L5）ごとに、複数の異なる疾患タイプとその重症度を分類する必要があるため、**マルチラベル分類問題**となります。

**データセットの形式 (Dataset Format)**

提供される主なデータは、腰椎の医用画像とそのラベル情報です。

1.  **医用画像データ:**
    * 患者ごとの腰椎の画像データ。**MRI (磁気共鳴画像法)** が主である可能性が高いです（椎間板や神経などの軟部組織の描出に優れるため）。
    * T1強調画像、T2強調画像など、複数のシーケンス（撮影条件）や、矢状断像（Sagittal）、軸位断像（Axial）など複数の断面が含まれることが想定されます。
    * ファイル形式は、医用画像の標準である **DICOM (`.dcm`)** 形式で提供される可能性が高いです。データは通常、患者ID (`study_id`) やシリーズID (`series_id`) ごとに整理されています。

2.  **ラベルデータ (`train.csv` など):**
    * トレーニングデータに含まれる各患者（または特定の解剖学的位置）に対する専門医による分類ラベル。CSV形式で提供されるのが一般的です。
    * 列には通常、`study_id` (患者/検査のID)、分類対象となる位置（例: `vertebral_level`）、分類対象の疾患 (`condition_type`)、そして**ターゲット変数**であるその疾患の有無や重症度 (`severity_grade` など) が含まれます。1つの検査に対して多数のラベル行が存在するマルチラベル形式になります。

3.  **テストデータ:**
    * トレーニングデータと同様の形式の医用画像データ（DICOMファイル群）。ただし、ラベル情報は含まれません。
    * `test.csv` のようなファイルで、予測対象となる患者/検査がリストアップされます。

4.  **`sample_submission.csv`**:
    * 提出フォーマットのサンプル。通常、予測対象となる各ラベル（例: 患者IDと特定の疾患/位置の組み合わせを示す `row_id` など）に対して、各クラス（例: 正常、軽度、中等度、重度）に属する**確率**を記述する形式となります。

**評価指標 (Evaluation Metric)**

* **指標:** **Weighted Log Loss (加重対数損失)**
* **計算方法:** Log Lossは、予測された確率と実際のクラスラベル（通常は0か1）との間の「距離」を測る指標です。Weighted Log Lossでは、各分類ターゲット（特定の疾患や位置、重症度レベルなど）に対して異なる重みが適用されます。
    Weighted Log Loss = - (1/N) * Σ [ w * (y * log(p) + (1-y) * log(1-p)) ]
    ここで、
    * `N`: 全予測対象ラベルの総数
    * `Σ`: 全ての患者、全ての分類ターゲットにわたる合計
    * `w`: その特定の分類ターゲットに割り当てられた重み
    * `y`: 真のラベル（例: その状態が存在する場合は1、しない場合は0）
    * `p`: モデルが予測した、その状態が存在する確率（0から1の間）
* **意味:** Log Lossは、特に確率的な予測値の精度を評価するのに適しており、自信を持って間違った予測（確率0または1に近い値を誤って予測）に対して大きなペナルティを与えます。加重（Weighted）が付いているため、臨床的な重要度やクラスの不均衡などを考慮して、特定のターゲットの予測精度が全体のスコアにより大きな影響を与えるように調整されています。この指標は**小さい**ほど、モデルの予測確率が真のラベルに対してより正確で、かつ適切に較正（キャリブレーション）されていることを示します。

要約すると、RSNA 2024コンペティションは、腰椎のMRI画像（主にDICOM形式）を用いて、複数の場所における複数の変性疾患の有無や重症度を分類するマルチラベル分類タスクです。性能は、各分類ターゲットの重要度を考慮した加重対数損失（Weighted Log Loss、小さいほど良い）によって評価されます。

---

**全体的な傾向:**

このコンペでは、腰椎のMRI画像から椎間板ヘルニアや脊柱管狭窄などの変性疾患の重症度を分類することが課題です。上位解法は、大きく分けて2つのステージで構成されています。最初のステージでは、病変領域のキーポイント（座標）を検出し、2番目のステージでは、その領域を切り出した画像を用いて疾患の重症度を分類します。3D CNN、2D CNN、2.5D CNN、Transformer、LSTM、Attention機構など、多様なアーキテクチャが用いられ、データ拡張、アンサンブル学習、ラベルノイズへの対処などが重要なテクニックとして活用されています。

**各解法の詳細:**

**1位**

- **アプローチ:** 2段階アプローチ：テストラベル座標の作成と重症度の予測。最初の段階は、インスタンス番号予測と座標予測に分離。3種類のモデル（インスタンス番号予測、座標予測、重症度予測）を使用。
- **アーキテクチャ:**
    - **インスタンス番号予測 (矢状断):** 3D ConvNeXt。
    - **座標予測 (矢状断/軸位断):** 2Dエンコーダ（ConvNeXt-base、Efficientnet-v2-l）+レベル分離ヘッド。
    - **インスタンス番号予測 (軸位断):** Hengck23氏の方法を借用。
    - **重症度予測:** 2.5Dモデル、AttentionベースMIL（Multi-Instance Learning）、bi-LSTM。
- **アルゴリズム:** L1損失、交差エントロピー損失、AdamWオプティマイザ。
- **テクニック:**
    - **データ前処理:** ボリュームの正規化、DICOMメタデータによるソートとパディング、座標ラベルの正規化、画像のクロッピング（座標に基づく）、データ拡張（ランダムシフト、回転、明るさ、コントラストなど）。
    - **1段階目:** 回帰と分類の2つのタスクでインスタンス番号を予測。中央のインスタンス番号を持つ5つの画像を使用して座標を予測。軸位断のインスタンス番号予測にはHengck23氏の方法を使用。
    - **2段階目:** MIL（Attentionベース）による重症度分類。bi-LSTMと補助損失の追加。
    - **アンサンブル:** 中央値（インスタンス番号）、平均（座標）、重み付き平均（重症度）。

**2位**

- **アプローチ:** 軸位断と矢状断で別々のモデルを訓練し、各ターゲットに対して個別のモデルを作成。ノイズの多いラベルデータを除去し、分類モデルを再訓練。最終的な予測は、個々の予測の単純なブレンドと小さな後処理。
- **アーキテクチャ:** YOLOX（関心領域推定）、ConvNeXt Small（軸位断分類）、Timmモデル（矢状断スライス分類）、MILモデル（5画像入力、ConvNeXt Smallバックボーン）。
- **アルゴリズム:** StratifiedGroupKFold、AdamWオプティマイザ。
- **テクニック:**
    - **軸位断:** スライス分類（レベル予測）、YOLOXによる関心領域推定、ConvNeXt Smallによる重症度分類（脊椎と非脊椎で異なる扱い）。
    - **矢状断:** スライス分類（脊椎と関節突起間ターゲット）、YOLOX（Brendan氏のデータセットで訓練）による関心領域推定、水平方向のレベル分割とクロッピング、MILモデル（5スライス入力、ConvNeXt Smallバックボーン）による分類。
    - **ノイズ除去:** アンサンブルOOFを使用して損失の高いサンプルを除去。
    - **後処理:** 脊椎の重症度の最高予測値を1.25倍。
    - **アンサンブル:** メンバーの予測の重み付き平均。

**3位**

- **アプローチ:** 2段階パイプライン：各椎間板レベルでの矢状断画像のクロッピングと、椎間孔狭窄と関節突起間狭窄の重症度を分類するためのセンター分類器とサイド分類器の使用。
- **アーキテクチャ:** CenterNet（椎間板レベルと脊柱管のキーポイント検出）、2Dエンコーダ（ResNet、MNasNet、EfficientNet、ConvNeXt、MaxViT）+ Attention（センター/サイド分類器）。
- **アルゴリズム:** AdamWオプティマイザ、OneCycleLRスケジューラ、Cross-Entropy損失（重み付き）、Mixup（オプション）。
- **テクニック:**
    - **1段階目:** CenterNetによる椎間板レベルと脊柱管のキーポイント検出、キーポイントに基づく画像のクロッピング（矢状断と軸位断）。軸位断スライスの椎間板レベルへの割り当て。
    - **2段階目:** センター分類器（脊柱管狭窄）とサイド分類器（椎間孔狭窄、関節突起間狭窄）による重症度分類。複数の入力スライス、Attention機構、補助損失、テスト時拡張（TTA）。
    - **検証戦略:** StratifiedKFold（moderate以上の症例数、study_id）。
    - **疑似ラベリング:** オプション。
    - **アンサンブル:** 単純平均（30モデル）。
    - **後処理:** 脊柱管狭窄のロジットに温度スケーリング（0.91）。

**4位**

- **アプローチ:** 関心領域（症状のある部位）のキーポイントを検出し、周囲のクロップを入力として分類モデルを構築。スタッキングモデルで結果を洗練。
- **アーキテクチャ:** 2.5D CNN + LSTM（椎間板レベル検出）、UNet（キーポイント検出）、caformer_s18、convnext_tiny、resnetrs50、swinv2_tiny（分類モデルバックボーン）、Transformerエンコーダ、MLP（スタッキング）。
- **アルゴリズム:** BCELoss、DICELoss、AdamWオプティマイザ、Nelder-Mead（スタッキングの重み最適化）。
- **テクニック:**
    - **キーポイント検出:** 椎間板レベル検出、軸位断/矢状断T1/T2のキーポイント検出（2.5D CNN + LSTM、UNet）。矢状断のキーポイント検出（tattaka）。
    - **分類モデル:** マルチビュー入力、マルチコンディション出力モデル（tattaka）、シングルビュー入力、シングルコンディション出力モデル（yu4u）。クロップサイズはキーポイント間の距離に基づく。TransformerエンコーダとAttention Pooling。
    - **アンサンブルとスタッキング:** MLPスタッキング（Nelder-Mead最適化）、LightGBMとXGBoostスタッキング。

**5位**

- **アプローチ:** ヒートマップベースの検出、ガウス拡大ラベル、外部データセットを利用した1段階目と、2.5Dモデル（CNN + RNN）、レベルごとのシーケンスモデリング、2段階トレーニングを用いた2段階目。
- **アーキテクチャ:** 2D UNet（EfficientNet-B5バックボーン）、Transformer/LSTM（シーケンスモデリング）、ConvNeXt（2段階目CNNバックボーン）。
- **アルゴリズム:** AdamWオプティマイザ、カットミックス。
- **テクニック:**
    - **1段階目:** ヒートマップベースのキーポイント検出（25クラス）、ガウスフィルタによるラベル拡張、外部データセット（Brendan氏のデータセット）の利用。
    - **2段階目:** キーポイントに基づくクロッピング（±2スライス、±32ピクセル）、2.5Dモデル（CNN + RNN）によるレベルごとのシーケンスモデリング、クラス間の関係をモデル化する追加モジュール。
    - **データ拡張:** カットミックス（p=1.0）。
    - **トレーニング:** 2段階トレーニング（AUC最大化のための事前トレーニング、コンペティションメトリック最適化のためのファインチューニング）。
    - **アンサンブル:** 多様なバックボーンのアンサンブル、TTAライクなアンサンブル。

**6位**

- **アプローチ:** 研究またはシリーズレベルで個々の椎間板レベルごとにトレーニングされた複数のモデルのアンサンブル。最初の段階で元のMRIのクロップを分離し、クロップのシーケンスを使用して状態の重症度を予測。最終結果は、コンペティションメトリックを直接最適化するMLPモデルを使用して集約。
- **アーキテクチャ:** 2D CNN、RNN（2.5Dモデル）、MLP。
- **テクニック:**
    - **データ準備:** 椎間板レベルごとの画像のクロッピング。
    - **モデル:** 2D CNN（EfficientNet）、RNN（重症度予測）、MLP（予測の集約）。
    - **トレーニング:** シリーズレベルまたは個々の椎間板レベルでトレーニング。
    - **アンサンブル:** MLPによる予測の集約。

**7位**

- **アプローチ:** 1段階と2段階のアンサンブル。1段階目はキーポイント回帰（2Dと3D）、2段階目はキーポイントでクロップし、特徴空間で3つのビューを融合するモデルと、単一ビューで3種類の状態を予測するモデル。
- **アーキテクチャ:** Timmモデル（2Dキーポイント回帰）、Timm-3Dモデル（3Dキーポイント回帰）、2.5Dモデル（CNN + LSTM + Attention）、ConvNeXt。
- **テクニック:**
    - **1段階目:** 2Dおよび3Dキーポイント回帰（矢状断と軸位断）。ITKのベースラインで検索されたバックボーンを使用。
    - **2段階目_モデル1:** 矢状断（2Dキーポイント）と軸位断（3Dキーポイント）のキーポイントを使用し、特徴空間で3つのビューを融合。
    - **2段階目_モデル2:** 3D ROI画像をXYZポイントに基づいてクロップ。軸位断では信頼度の高い検出のみを使用。
    - **アンサンブル:** stage2_model1とstage2_model2を様々なバックボーンとTTA（矢状断の水平反転、軸位断の垂直反転）でアンサンブル。

**8位**

- **アプローチ:** 2D分類器と1D分類器を組み合わせたアーキテクチャ。1段階目の特徴抽出では、注意機構のようにヒートマップを重みとして使用。SSL（自己教師あり学習）とリラベリングも試行。
- **アーキテクチャ:** 2D分類器（CNNバックボーン）、1D分類器（2D分類器の出力をスタック）、ConvNeXt。
- **テクニック:**
    - **1段階目:** 2D画像をCNNバックボーンで処理し、ヒートマップを生成（検出器として使用）。ヒートマップを特徴抽出の重みとして使用。
    - **2段階目:** 1段階目の出力をスタックし、1D CNNで最終予測。
    - **SSL:** xyz座標を使用してマルチビュー類似性を学習。
    - **リラベリング:** アノテーションツールの作成とラベルの修正を試行。

**9位**

- **アプローチ:** ガウスヒートマップベースのキーポイント検出（DeepLabV3Plus）と、レベルごとのROI分類（2.5Dモデル + GRUヘッド + ResNet18/Swin-Tiny/ConvNeXt-Nanoバックボーン）の2段階アプローチ。
- **アーキテクチャ:** DeepLabV3Plus（キーポイント検出）、ResNet18、Swin-Tiny、ConvNeXt-Nano（分類モデルバックボーン）、GRUヘッド。
- **アルゴリズム:** AdamWオプティマイザ、CosineAnnealingLRスケジューラ、MSE損失（キーポイント検出）、交差エントロピー損失（分類）。
- **テクニック:**
    - **1段階目:** シリーズタイプごとにDeepLabV3Plusでキーポイントを検出（ガウスヒートマップ）。
    - **2段階目:** キーポイントを中心としたROIをクロップし、2.5Dモデル（CNN + GRU）でレベルごとに分類。分割モデル（個々の状態を予測）とグローバルモデル（すべての状態を予測）を使用。
    - **データ拡張:** 回転、せん断、チャンネルシャッフル、シャープニング/モーションブラー。
    - **アンサンブル:** 分割モデルとグローバルモデルを、異なる特徴抽出器（ResNet18、Swin-Tiny、ConvNeXt-Nano）でアンサンブル。

**10位**

- **アプローチ:** 多項式近似アプローチ。トランジットの入り口/出口の瞬間を切り取らずに、信号全体を使用。
- **テクニック:**
    - **トランジットゾーン検出:** スライディングウィンドウでの導関数計算による強度変化の検出、導関数の極値に基づくトランジットの中点の推定、線形セクションによるトランジット開始の正確な決定。
    - **トランジット回復関数:** 滑らかな関数（Desmosで定義）によるトランジットのモデル化。
    - **予測収集パイプライン:** 波長ビニング集約とランダムサンプルインデックス選択によるターゲットの計算、トランジットの開始/終了/期間のパラメータ計算、正規化された信号での多項式フィッティング、波長インデックスの反復処理とサブサンプルの最適化。
    - **シグマ推定:** 勾配ブースティングによる予測特徴量からのシグマ推定（「良い」波長と「ノイズの多い」波長で別々に予測）。