---
tags:
  - Kaggle
  - 組合せ最適化
  - 焼きなまし法
startdate: 2024-11-22
enddate: 2025-02-01
---
# Santa 2024 - The Perplexity Permutation Puzzle
https://www.kaggle.com/competitions/santa-2024

**概要 (Overview)**

* **目的:** このコンペティションの目的は、与えられた一連のアイテム（例えば、テキストの断片や文など）の最適な**順列（Permutation）**を見つけ出すことです。ここで「最適」とは、その順列に従ってアイテムを連結または処理した際に、事前に定義された**言語モデル**によって計算される**パープレキシティ（Perplexity）**が最小になるような順序を指します。
* **背景:** Kaggleの「Santa」コンペティションは、毎年恒例の最適化問題チャレンジです。2024年版は、組み合わせ最適化（最適な順列を見つける）と自然言語処理（パープレキシティという指標を用いる）の要素を融合させています。パープレキシティは、言語モデルがあるシーケンスをどれだけ「予測しにくい」と感じるかを示す指標であり、低いほどそのシーケンスがモデルにとって「自然」または「ありそう」であることを意味します。この課題は、例えば文の断片を最も自然な順序に並べ替えるといったタスクに関連する可能性があります。
* **課題:** 考慮すべき順列の総数はアイテム数が増えると爆発的に増加するため、全順列を試すことは不可能です。また、各順列に対して言語モデルを用いてパープレキシティを計算するのも計算コストがかかります。参加者は、効率的な探索アルゴリズムやヒューリスティクスを用いて、パープレキシティが低い順列を現実的な時間内に見つけ出す必要があります。使用される言語モデルの種類やパープレキシティの具体的な計算方法が、アプローチの鍵となります。タスクは**最適化問題**です。

**データセットの形式 (Dataset Format)**

提供される主なデータは、順列を決定する対象となるアイテムのリストと、評価に用いる言語モデルに関する情報です。

1.  **入力アイテムデータ (`items.csv`, `puzzle_input.txt` など):**
    * 順列の対象となるアイテムのリスト。CSVやテキストファイル形式で提供されることが考えられます。
    * 各アイテムにはIDが付与され、内容（例: テキスト断片）が含まれる場合があります。

2.  **評価用言語モデル情報:**
    * パープレキシティ計算に使用される特定の言語モデルに関する情報（例: Hugging Face Hub上のモデル名）や、パープレキシティを計算するためのAPIまたは評価スクリプトが提供される可能性があります。

3.  **データ分割なし:**
    * これは最適化問題であり、予測モデルを訓練する形式ではないため、通常の訓練データ・テストデータの分割はありません。参加者には、解くべき問題インスタンス（全アイテムのリスト）が提供されます。

4.  **`sample_submission.csv`**:
    * 提出フォーマットのサンプル。通常、`permutation` や `path` などの列に、並べ替えたアイテムのIDの順序付きリスト（例: `[item_3, item_0, item_5, ...]`）を記述する形式となります。

**評価指標 (Evaluation Metric)**

* **指標:** **Perplexity (パープレキシティ)**
* **計算方法:**
    1.  参加者が提出したアイテムIDの順列（並び順）を取得します。
    2.  ルールに従って、この順序でアイテムを連結または処理し、一つのシーケンスを形成します。
    3.  事前に指定された言語モデルを用いて、生成されたシーケンスのパープレキシティを計算します。パープレキシティは通常、モデルがシーケンスの各要素（例: トークン）に割り当てる対数尤度の平均値に関連しています（具体的には、平均対数尤度の負の値の指数関数: PPL = exp(-avg(log P))）。
    4.  計算されたパープレキシティの値が、その提出のスコアとなります。
* **意味:** パープレキシティは、言語モデルにとってそのシーケンスがどれだけ「ありえない」か、あるいは「予測しにくい」かを示す指標です。値が**低い**ほど、その順列によって形成されたシーケンスが、言語モデルにとってより自然で、より確率が高い（予測しやすい）ことを意味します。このコンペティションの目的はパープレキシティを最小化することなので、スコアが低いほど優れた解と評価されます。

要約すると、Santa 2024コンペティションは、与えられたアイテム群の順列（並び順）を最適化し、その結果として得られるシーケンスのパープレキシティ（言語モデルによる評価）を最小にする問題です。データはアイテムリストと評価用モデル情報から成り、性能は計算されたパープレキシティの値（小さいほど良い）によって評価されます。

---

**全体的な傾向:**

このコンペでは、テキストの並べ替え問題が出題され、perplexityを最小化することが目標でした。上位解法は、主に局所探索法（近傍探索）、シミュレーテッドアニーリング（SA）、ビームサーチなどのメタヒューリスティックアルゴリズムを用いています。初期解の生成方法や、局所最適解からの脱出戦略（キック操作）、そして、問題ごとの特性に合わせたアルゴリズムの調整が重要でした。

**各解法の詳細:**

**1位**

-   **アプローチ:** Simulated Annealing (SA) を基本とし、スコアリングの高速化と、特に「Swap Star」を中心とした効果的な近傍探索戦略、および探索を効率化するための適応的な操作選択を組み合わせたアプローチ。
-   **アーキテクチャ:** 特定のアーキテクチャの記述はありません。解法は主にSAアルゴリズムとそれを補助するテクニックで構成されています。
-   **アルゴリズム:** Simulated Annealing (SA)。
-   **テクニック:**
    -   **近傍探索操作:**
        -   **Swap Star:** Pivot単語と他の全単語との交換を効率的に評価・実行。最も重要な操作。
        -   **Insert:** 単語の削除と別位置への挿入。
        -   **Swap:** 2単語の位置交換。
        -   **2-opt:** 部分列の反転。
        -   **Block Move (Insert Block):** 連続ブロックの移動・挿入。
    -   **スコアリング高速化:** パープレキシティ計算をC++で実装し、大幅な速度向上（約15倍）を実現。
    -   **適応的近傍選択:** SA実行中に各近傍操作の有効性を評価し、効果の高い操作がより頻繁に選ばれるように選択確率（重み）を動的に調整。
    -   **初期テキスト戦略:** 問題に応じて最適な初期順列を選択（例: 問題5では「ソート済みストップワード + ソート済みその他 + ソート済み動詞」、他の問題ではアルファベット順ソートなど）。
    -   **リスタート戦略:** 探索が停滞した場合に温度をリセットするなどして探索を再活性化。
    -   **アンサンブル/ブレンディング:** 異なる設定や乱数シードで複数回実行し、最良の結果を採用。

**2位**

- **アプローチ:**
    1. より低いperplexityを持つ順列を探索するための、解の周囲の順列の局所近傍を定義。
    2. 探索するより良い方向がない場合に、局所最適解から抜け出すためのキック操作。
- **アーキテクチャ:** 特定のアーキテクチャの記述はありません。
- **アルゴリズム:** 局所探索（近傍探索）、キック操作。
- **テクニック:**
    - **局所近傍探索:** 単語またはフレーズの削除と挿入、2つのフレーズの交換。
    - **キック操作:** 解の一部をスクランブル、単語の移動、順列操作の再試行。
    - **問題固有の戦略:**
        - 問題3: 最後の単語を固定して探索。
        - 問題5: 以前の問題の解を組み合わせて初期解を生成し、カスタムキックを実装。
    - **試行されなかった手法:** Simulated Annealing、Late acceptance hill climbing、分割統治法、Branch and Bound、Multi-Arm Bandit。

**3位**

- **アプローチ:** 候補生成に関連する修正を加えたSimulated Annealing（SA）。
- **アーキテクチャ:** 特定のアーキテクチャの記述はありません。
- **アルゴリズム:** Simulated Annealing（SA）。
- **テクニック:**
    - **カスタム重み付き候補生成:** スコアに基づいて操作に重みを付ける。単語の重要度をperplexityに基づいて計算。操作のパフォーマンスに基づいて重みを更新。
    - **強化されたSimulated Annealing:** 操作の追跡、同等の最高スコアのテキストの考慮、改善が見られない場合の再選択。
    - **初期テキスト（開始点）:** アルファベット順ソート、ストップワードなどをソート、ランダムな開始点、ソートされた品詞。
    - **2番目のアプローチ:** より多くの操作、周期的冷却、許容エネルギー範囲の制限、異なる開始シーケンス戦略、操作の重み付け。

**4位**

- **アプローチ:** 挿入最適化と局所最適化を繰り返すループ（ILS）。[@daiwakun](https://www.kaggle.com/daiwakun)によるキック付きビームサーチ。
- **アーキテクチャ:** 特定のアーキテクチャの記述はありません。
- **アルゴリズム:** 局所探索、ビームサーチ、挿入最適化。
- **テクニック:**
    - **挿入最適化:** ランダムに選択された単語をビームサーチで挿入。
    - **局所最適化:** サブセクションのシャッフル、単語の交換、単語の移動などを繰り返す。
    - **発見:** 特定の単語を先頭に配置することの利点、機能語（ストップワード）をまとめて先頭に配置する傾向、内容語のアルファベット順、分割ソート（問題5）、機能語からの「and」の削除（問題5）。

**5位**

- **アプローチ:** 局所探索（Simulated Annealingの変種）と、並列探索によるGPUの効率的な利用。
- **アーキテクチャ:** 特定のアーキテクチャの記述はありません。
- **アルゴリズム:** Simulated Annealing（SA）の変種、マルチポイントサーチ。
- **テクニック:**
    - **Simulated Annealingの変種:** スコアが改善された解は常に保持。悪化したスコアの解は、グローバルな上限を下回る場合に保持。
    - **マルチポイントサーチ:** N個のSAを並列実行。交叉（crossover）の利用。
    - **移動（近傍生成）:** k-opt、削除 - 挿入、ダブルルートアンドステム。
    - **高速化:** テキストスコアのグローバルキャッシュ。
    - **割引されたperplexity:** 単語シーケンスの先頭付近の変更を重視。移動をプレフィックスに制限、または割引されたスコアを使用。
    - **試行されなかった手法:** 順列行列、ATSP解の計算、強化学習を用いたシーケンス予測。

**7位**

- **アプローチ:** Iterated Local Search（ILS）とSimulated Annealing（SA）を組み合わせ、枝刈りされた距離行列、キャッシュメカニズム、分散並列コンピューティングを活用。
- **アーキテクチャ:** 特定のアーキテクチャの記述はありません。
- **アルゴリズム:** Simulated Annealing（SA）、Iterated Local Search（ILS）。
- **テクニック:**
    - **Simulated Annealing Search（SA Search）:** 温度低下、近傍探索（挿入、スワップ、ローカルシャッフル）、バッチ近傍探索。
    - **Multi-round Simulated Annealing Search（Repeat SA Search）:** SAの繰り返し適用、早期停止メカニズム。
    - **Iterated Local Search（ILS）:** 大きな摂動（ランダムな位置の単語のシャッフル）。
    - **効率的なスコアキャッシュ:** 辞書による実装、バイナリエンコーディングによるストレージ効率化、msgpackによるディスクアクセス高速化。
    - **枝刈り:** 距離行列（2-gramモデルに基づき初期化、動的に最適化）を用いた候補解の枝刈り。

**9位**

- **アプローチ:** すべての6つのテストケースの解を探索するために、Edge Assembly Crossover（GA-EAX）を使用する遺伝的アルゴリズム。ID=0,1,2では、初期にテストされたSAを使用。
- **アーキテクチャ:** 特定のアーキテクチャの記述はありません。
- **アルゴリズム:** 遺伝的アルゴリズム（GA）、Edge Assembly Crossover（EAX）、Simulated Annealing（SA）。
- **テクニック:**
    - **GA手順:** SAによる初期世代の作成、EAXによる子の生成、局所探索とSAによる子の改善、次世代の選択を繰り返す。
    - **初期個体と近傍操作:** ランダム初期個体、ストップワードの位置、アルファベット順ソートなどを利用。ランダム3-optなどの近傍探索。
    - **EAXによる子の生成と選択:** ロジットを利用したエッジ選択、親との比較による改善された子の選択。多様性を維持するためのペナルティ。

**10位**

- **アプローチ:** Simulated Annealing（SA）のみを使用。良好な結果を得るための鍵は、SAの開始文の実験と適切な選択、SAの十分な理解と制御、計算リソース。
- **アーキテクチャ:** 特定のアーキテクチャの記述はありません。
- **アルゴリズム:** Simulated Annealing（SA）。
- **テクニック:**
    - **SAの開始文の実験と選択:** ストップワードの配置、アルファベット順ソートなどを利用。
    - **SAの理解と制御:** 近傍の生成（単語のスワップ、挿入）、SAのパラメータ調整（初期温度、最終温度、冷却スケジュールなど）、受理率の監視。
    - **SAの実行タイプ:** 高温探索、ウォームアップ実行、低温探索。