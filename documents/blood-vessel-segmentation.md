---
tags:
  - Kaggle
  - 物体検出
  - セグメンテーション
  - 画像認識処理
startdate: 2023-11-08
enddate: 2024-02-07
---
# SenNet + HOA - Hacking the Human Vasculature in 3D
https://www.kaggle.com/competitions/blood-vessel-segmentation

**全体的な傾向:**

このコンペでは、腎臓の3D MRI画像から血管をセグメンテーションすることが課題です。上位解法は、主に2Dおよび2.5DのU-Netベースのアーキテクチャと、3D U-Netを使用しています。データ拡張、特に3D回転を含む拡張、損失関数の工夫（Focal Loss、Dice Loss、Boundary Loss、カスタム損失）、そしてテスト時のTTA（Test Time Augmentation）が重要なテクニックとして用いられています。また、複数の軸（xy, xz, yz）からの推論結果を組み合わせるアンサンブルも効果的でした。

**各解法の詳細:**

**1位**

- **アプローチ:** 2つの2.5D ConvNeXt Tiny U-Netのアンサンブル。データ拡張とエポック数のみが異なる。3Dスライス回転によるデータ拡張が鍵。
- **アーキテクチャ:** U-Net（SMP）、ConvNeXt Tinyバックボーン、GroupNorm、GELU、追加の畳み込みステム。
- **アルゴリズム:** AdamWオプティマイザ、CosineAnnealingLRスケジューラ。Focal Loss、Dice Loss、Boundary Loss、カスタム損失。
- **テクニック:**
    - **データ準備:** 全トレーニングデータ（kidney_1_voiを含む）、マルチビュー（x, y, zスライス）、正規化なし（0-1）、1536x1536にリサイズまたはクロップ、豊富なデータ拡張（水平/垂直フリップ、転置、アフィン変換、輝度/コントラスト、ブラー、弾性変換、グリッド歪み、リサイズ/クロップ、ガウスノイズ）、ランダム3D回転。
    - **モデリング:** 2.5D U-Net（3チャンネル入力）。
    - **推論:** 3軸での推論、8xTTA、ダイナミックスケールまたは固定サイズ（3072x3072）へのリサイズ、閾値0.4、`torch.compile()` による高速化。

**2位**

- **アプローチ:** U-Net3D、閾値調整、連結されていない血管を除去するポスト処理。ランダム回転（と位置）によるデータ拡張。
- **アーキテクチャ:** U-Net3D (128x128x32)。
- **アルゴリズム:** AdamWオプティマイザ、CosineDecayスケジューラ、Binary-Focal Loss。深さ優先探索（DFS）（ポスト処理）。
- **テクニック:**
    - **データ準備:** 3D Numpy配列、スケール調整、疎なデータで学習。正規化やクリッピングはなし。ランダムな位置と回転からのデータ生成。
    - **モデル:** U-Net3D。
    - **推論:** タイリングによる予測、比率に基づいた候補の発見、小さな連結されていない塊の除去（DFS）。

**3位**

- **アプローチ:** 疎なラベルから密なラベルへの洗練、テストセットの倍率の模倣、適切な解像度の維持。2Dモデル（MelSpectrogram変換+CNNバックボーン）と1Dモデル（CNN + Squeezeformerブロック）のアンサンブル。
- **アーキテクチャ:** UNet（maxViT512、EfficientNetv2s、SeResNext101）、UNet++（EfficientNetv2l）、1D CNN（Squeezeformerブロック）。
- **アルゴリズム:** torchaudio（MelSpectrogram）、バターバンドパスフィルタ、ランダムシフト、MixUp。
- **テクニック:**
    - **ラベル洗練:** 密なラベルデータで疎なラベルデータを補完。
    - **倍率模倣:** トレーニング中にスケーリングの中心を0.8に設定し、倍率の違いをシミュレート。
    - **解像度維持:** 主に512の解像度で動作し、適切な解像度のスライスにはより高い解像度の重みを使用。
    - **データ拡張:** オーバーライト、帯域幅変更、時間シフト、左右反転、脳の左右入れ替え（1D）、中心10秒のシフト（2D）。
    - **アンサンブル:** 2D CNNと1D CNNのアンサンブル、学習されたブレンド重み、クラスごとのバイアス項によるポスト処理。

**4位**

- **アプローチ:** Boundary DoU Lossを用いた2Dおよび3Dモデルの混合。d4 TTA、マルチビューTTA。2フォールド設定（kidney_2とkidney_3_denseを検証）。
- **アーキテクチャ:** UnetPlusPlusデコーダとSCSEアテンションを備えたEfficientNetファミリーモデル（2D）、DynUnet（3D）。
- **アルゴリズム:** AdamWオプティマイザ、Cosine LRスケジューラ、SGDオプティマイザ、BoundaryDOULoss。
- **テクニック:**
    - **データ準備:** 5つのデータセット（kidney_1_dense, kidney_2, kidney_3_dense, kidney_3_sparse, pseudo labels）、スタックワイズ正規化、疎なサンプルと密なサンプルに対する重み付きサンプリング、CutMix。
    - **データ拡張:** シフト、スケール、回転、フリップ、ガンマ、コントラスト、ノイズ、ランダムクロップ（2D）、d4拡張、ランダムクロップ（3D）。
    - **モデル:** 2Dおよび3D UnetPlusPlus（EfficientNetバックボーン）、DynUnet（3D）。
    - **推論:** スライディングウィンドウ推論、マルチビューTTA（2D）、d4 TTA（両方）、ガウシアンマージ（3D）。
    - **ポスト処理:** 2Dモデルのバウンディングポリゴンと3Dモデルの予測の乗算。

**5位**

- **アプローチ:** 3D補間が鍵。追加データセット（kidney, spleen）、疑似アノテーション（ソフトラベル）、損失関数の工夫（境界強調）、解像度のアップスケールとダウンスケール。
- **アーキテクチャ:** U-Net（effnet_v2_s/m、maxvit_base、dpn68バックボーン）。
- **アルゴリズム:** CE + Dice + Focal損失、境界強調損失、Twersky損失、AdamWオプティマイザ。
- **テクニック:**
    - **データ:** kidney_1, kidney_3をベースに、kidney_2, LADAF-2020-31 kidney, LADAF-2020-27 spleenで疑似アノテーション。
    - **疑似アノテーション:** 4段階プロセス（段階的に疑似ラベルを生成）。ハードラベルではなくソフトラベルを使用。
    - **損失:** 境界を強調したCE損失、Dice損失、Focal損失、Twersky損失。
    - **前処理:** 解像度のアップスケールとダウンスケール（x2補間）。
    - **推論:** xy, xz, yz軸での推論、クロップとストライドによるスライディングウィンドウ。

**6位**

- **アプローチ:** 運がすべて。2.5Dおよび3Dモデル、マルチビュー、ヘビーオーグメンテーション、確率閾値。
- **アーキテクチャ:** EfficientNetファミリー（B3, B5）、se_resnext50_32x4d（2.5D）、DynUNet（3D）、Unet++。
- **アルゴリズム:** Adamオプティマイザ、CosineAnnealingLRスケジューラ、SGDオプティマイザ、BoundaryLoss、Focal Symmetric Loss。
- **テクニック:**
    - **データ:** 全トレーニングデータ（kidney_1_voiを除く）、LADAF_2020_31_kidney_pag（疑似ラベル）、パーセンタイル正規化。
    - **トレーニング:** 2.5D（5スライス、マルチビュー、ヘビーオーグメンテーション、CutMix）、3D（ヘビーオーグメンテーション、ランダムスケール強度）。
    - **損失:** BCE + Dice損失、BoundaryLoss、Focal Symmetric Loss。
    - **推論:** スライディングウィンドウ（512、オーバーラップ0.5）、フリップTTA、マルチビューTTA。
    - **ポスト処理:** アルゴリズムによる腎臓マスクの作成。

**7位**

- **アプローチ:** 2.5D画像を入力とするハイブリッドモデル（2D U-Net + 3D畳み込み層）。3D回転によるデータ拡張、疑似ラベリング、損失関数の工夫（チャンネルごとの重み付け）。
- **アーキテクチャ:** 2D U-Net、3D畳み込み層。
- **アルゴリズム:** AdamWオプティマイザ、CosineAnnealingLRスケジューラ、BCEWithLogitsLoss、DiceLoss、FocalLoss。
- **テクニック:**
    - **データ準備:** 3D回転によるデータ拡張、ターゲットセグメンテーションが存在し、背景が50%未満のスライスのみ保持、疑似ラベリング（kidney1/3で学習→kidney2を疑似ラベル化→kidney2で学習）。
    - **モデル:** 3チャンネル2.5D画像を入力とし、3チャンネル予測を出力。中央チャンネルに高い重みを設定した損失関数。
    - **推論:** オリジナル解像度、3チャンネル2.5D入力、x, y, z軸での予測平均、水平フリップTTA、閾値処理（0.2）、3Dクロージング処理。

**8位**

- **アプローチ:** 2D分類器と1D分類器を組み合わせたアーキテクチャ。1段階目の特徴抽出では、注意機構のようにヒートマップを重みとして使用。SSL（自己教師あり学習）とリラベリングも試行。
- **アーキテクチャ:** 2D分類器（CNNバックボーン）、1D分類器（2D分類器の出力をスタック）。
- **テクニック:**
    - **1段階目:** 2D画像をCNNバックボーンで処理し、ヒートマップを生成（検出器として使用）。ヒートマップを特徴抽出の重みとして使用。
    - **2段階目:** 1段階目の出力をスタックし、1D CNNで最終予測。
    - **SSL:** xyz座標を使用してマルチビュー類似性を学習。
    - **リラベリング:** アノテーションツールの作成とラベルの修正を試行。

**9位**

- **アプローチ:** ガウスヒートマップベースのキーポイント検出（DeepLabV3Plus）と、レベルごとのROI分類（2.5Dモデル + GRUヘッド + ResNet18/Swin-Tiny/ConvNeXt-Nanoバックボーン）の2段階アプローチ。
- **アーキテクチャ:** DeepLabV3Plus（キーポイント検出）、ResNet18、Swin-Tiny、ConvNeXt-Nano（分類モデルバックボーン）、GRUヘッド。
- **アルゴリズム:** AdamWオプティマイザ、CosineAnnealingLRスケジューラ、MSE損失（キーポイント検出）、交差エントロピー損失（分類）。
- **テクニック:**
    - **1段階目:** シリーズタイプごとにDeepLabV3Plusでキーポイントを検出（ガウスヒートマップ）。
    - **2段階目:** キーポイントを中心としたROIをクロップし、2.5Dモデル（CNN + GRU）でレベルごとに分類。分割モデル（個々の状態を予測）とグローバルモデル（すべての状態を予測）を使用。
    - **データ拡張:** 回転、せん断、チャンネルシャッフル、シャープニング/モーションブラー。
    - **アンサンブル:** 分割モデルとグローバルモデルを、異なる特徴抽出器（ResNet18、Swin-Tiny、ConvNeXt-Nano）でアンサンブル。