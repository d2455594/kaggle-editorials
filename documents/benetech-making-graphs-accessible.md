---
tags:
  - Kaggle
startdate: 2023-04-22
enddate: 2023-06-20
---
# Benetech - Making Graphs Accessible
https://www.kaggle.com/competitions/benetech-making-graphs-accessible


**概要 (Overview)**

- **目的:** このコンペティションの目的は、科学論文や一般的なドキュメントに含まれる**グラフやプロットの画像**から、その元となっている**数値データ（データ系列）を自動的に抽出する**モデルを開発することです。
- **背景:** グラフやプロット（散布図、線グラフ、棒グラフなど）は情報を視覚的に伝える強力な手段ですが、視覚障がいのある人々にとってはアクセスが困難です。これにより、教育や研究、専門職における情報格差が生じています。Benetechは、特にアクセシビリティの分野で、社会貢献のためのテクノロジー活用に取り組む組織です。このコンペティションは、グラフ情報を非視覚的な形式（数値データ）に変換することで、アクセシビリティを向上させることを目指しています。
- **課題:** 多種多様なグラフの種類（散布図、線グラフ、棒グラフなど）、スタイル、品質に対応できるモデルを構築すること。グラフ画像には、タイトル、軸ラベル、凡例、グリッド線など、データ抽出を複雑にする可能性のある様々な要素が含まれています。モデルはこれらの変動に対して頑健である必要があり、抽出されたデータを正確な形式で出力する必要があります。

**データセットの形式 (Dataset Format)**

提供される主なデータは、グラフの画像ファイルと、それに対応するグラフの種類や抽出対象の数値データを含む注釈（アノテーション）ファイルです。

1. **トレーニングデータ:**
    
    - `train/images/`: グラフの画像ファイル（例: PNG形式）。各画像には一意のIDが付与されています。
    - `train/annotations/`: 各画像に対応するJSON形式のアノテーションファイル。
    - **JSONアノテーション内の主要情報:**
        - `chart-type`: グラフの種類（例: `scatter`, `line`, `vertical_bar`, `horizontal_bar` など）。抽出ロジックが種類によって異なる可能性があるため重要です。
        - `data-series`: **ターゲット変数**。グラフにプロットされている実際のデータ点。散布図や線グラフの場合は `{x: 値, y: 値}` のペアのリスト。棒グラフの場合はカテゴリと値のペアのリストなど、グラフの種類に応じた形式で格納されています。
        - `axes`: X軸とY軸に関する情報（目盛りなど）。
        - その他、グラフの出典 (`source`) やテキスト要素に関する情報が含まれることもあります。
2. **テストデータ:**
    
    - `test/images/`: データ抽出対象となるグラフの画像ファイル。
    - 対応するアノテーションファイル（正解データ）は提供されません。参加者はこれらの画像から `data-series` を予測します。
3. **`sample_submission.csv`**:
    
    - 提出フォーマットのサンプル。通常、`id`（画像ID、場合によってはグラフタイプも含む）と `data_series`（抽出されたデータ系列を特定の文字列形式で表現したもの。例: `x1;y1 x2;y2 ...` や `category1;value1 category2;value2 ...`）の列を持ちます。

**評価指標 (Evaluation Metric)**

- **指標:** **正規化されたレーベンシュタイン距離 (Normalized Levenshtein Distance - NLD) に基づくカスタムスコア**
- **計算方法:**
    1. 正解のデータ系列 (`data-series`) とモデルが予測したデータ系列を、特定のルールに従って文字列形式に変換します。
    2. 2つの文字列間のレーベンシュタイン距離（一方の文字列をもう一方の文字列に変えるために必要な最小編集回数：挿入、削除、置換）を計算します。
    3. 計算されたレーベンシュタイン距離を、2つの文字列の長さの最大値などで割ることにより正規化し、NLD（0から1の値）を求めます。
    4. 最終的なスコアは **1 - NLD** として計算されます。
- **意味:** この指標は、モデルが抽出したデータ系列が、正解のデータ系列とどれだけ「近い」かを文字列編集距離に基づいて評価します。完全に一致する場合、レーベンシュタイン距離は0、NLDも0となり、スコアは**1**（最高評価）になります。不一致が多いほどNLDは1に近づき、スコアは0に近づきます。この指標により、数値のわずかな誤差や、点の抜けや余分な点の追加などが、編集距離に応じて評価に反映されます。スコアが**高い**ほど、モデルがグラフからデータを正確に抽出できていると評価されます。

要約すると、このコンペティションは、グラフ画像から元データを抽出するタスクであり、視覚障がい者のためのアクセシビリティ向上を目的としています。データは画像と、データ系列を含むJSONアノテーションで構成され、性能は予測されたデータ系列と正解データ系列の文字列類似度（正規化レーベンシュタイン距離に基づくスコア、1に近いほど良い）によって評価されます。

---
**全体的な傾向**

グラフ画像からデータ系列を抽出するこのタスクでは、多くの上位解法が**グラフタイプ分類**を前段に置き、グラフの種類に応じて後続の処理を切り替えるパイプラインアプローチを採用しました。特に**棒グラフ（Bar）**や**折れ線グラフ（Line）**に対しては、**Deplot**や**Matcha**といったImage-to-TextのTransformerモデルが非常に有効でした。一方、**散布図（Scatter）**や**ドットプロット（Dot）**に対しては、これらのモデルでは精度が出にくく、**物体検出モデル（YOLO系など）**でデータ点を検出し、軸ラベルのOCR結果と組み合わせて座標値を計算するアプローチが効果的でした。

データセットの多様性が精度向上の鍵となり、競技提供のデータ（特に抽出データ）だけでなく、**ICDARデータセット**などの外部データや、**matplotlib**などを用いて独自に生成した**合成データ**が広く活用されました。合成データ生成においては、単純なグラフだけでなく、ヒストグラム、エラーバー付きグラフ、複数行ラベル、特殊な数値フォーマットなど、現実世界のグラフに見られる多様なパターンを再現する工夫が凝らされました。疑似ラベルの活用や、アノテーションの手動修正・クリーニングも行われています。モデルの学習においては、マルチステージ学習（全体学習→特定タイプでファインチューニング）や、カスタムターゲット形式の定義、Augmentationなどが用いられました。最終的な提出は、異なるモデルやアプローチの結果をアンサンブルする手法が一般的でした。

**各解法の詳細**

**1位**

- **アプローチ:** 2段階パイプライン。グラフタイプ分類モデルの後、Bar/Line/Dotはタイプ別にファインチューニングしたDeplotで、Scatterは物体検出ベースでデータ系列を予測。
- **アーキテクチャ:** 分類: ConvNeXt-Large, Swin-Large。系列予測(Bar/Line/Dot): Deplot。系列予測(Scatter): YOLOXL (点検出), CACHED (ラベル位置検出), Deplot (ラベルテキスト読取)。
- **アルゴリズム:** Adafactor Optimizer, Cosine Scheduler w/ Warmup。物体検出、OCR。
- **テクニック:**
    - **データ:** 競技データ、ICDARデータ（手動修正含む）、自作合成データ（約65k、ヒストグラムやエラーバーなど多様性重視）、Brendan氏公開データ。
    - **タイプ分類:** ConvNeXtとSwinの重み付きアンサンブル。
    - **Deplot:** オリジナル形式のターゲットに変換。水平棒グラフは軸を入れ替えて学習・推論。マルチステージ学習（全タイプ→特定タイプ）。Vertical Barは2回、Lineは1回の追加学習。Horizontal Bar/Dotは追加学習せず全タイプ学習モデルを使用。
    - **Scatterパイプライン:** プロット領域をクロップ後、YOLOXで点を検出。CACHEDで軸ラベルのBBoxを検出。Deplotで軸ラベルのテキストを読み取り。BBoxとテキストをマッピングし、点座標を計算。
    - **アノテーション修正:** ICDARデータの手動修正、Scatter点の半自動アノテーション＋手動修正。

**2位**

- **アプローチ:** Image-to-Textモデル(Matcha-base)のみを使用。大規模な合成データを用いた2段階学習でドメイン適応と特化を行う。Scatter/Non-Scatterでモデルを分岐。
- **アーキテクチャ:** Matcha-base。
- **アルゴリズム:** AdamW (推定), Cosine Scheduler w/ Linear Warmup, EMA, Gradient Clipping, AWP。
- **テクニック:**
    - **データ:** 競技データ、自作合成データ（Wikitablesデータ利用、多様なグラフスタイル・要素・効果を導入、700k枚）、Bartley氏公開データ(25k)、Wikimedia疑似ラベルデータ(700枚、手動修正あり)、ICDARデータ(1100枚、後処理あり)。抽出データをオーバーサンプリング。
    - **学習戦略:** 2段階学習 (Phase 1: 合成データ主体でドメイン適応、Phase 2: 抽出データ主体で特化)。Phase 2ではScatterモデルとNon-Scatterモデルに分岐して学習。
    - **ターゲット形式:** カスタム形式 (`<|bos|> <|chart_type_start|> ... <|x_span_start|> ... <|y_span_end|> <|eos|>`)。数値は指数表記に変換。ヒストグラムは別タイプとして学習後、Vertical Barにマッピング。
    - **Augmentation:** Color Augmentation, Blur, Noise, Downscaleなど。

**3位**

- **アプローチ:** 2段階パイプライン。グラフタイプ分類後、Bar/LineはMatcha、Scatter/Dotは物体検出ベースで予測。自作合成データ活用。
- **アーキテクチャ:** 分類: NfNet-l2。系列予測(Bar/Line): Matcha-base。系列予測(Scatter/Dot): YOLOXL/m (点検出), CACHED (ラベル/メモリ検出), vietocr (OCR)。
- **アルゴリズム:** Model Soup (チェックポイント平均化)。物体検出(YOLOX)、OCR。NMS。
- **テクニック:**
    - **データ:** 競技データ、自作合成データ（訓練データの値・テキストを再利用し多様なスタイルで生成）。
    - **Validation:** 抽出データ全体をValidationとし、生成データのみで学習。
    - **タイプ分類:** NfNet-l2を使用。複数LR/Seedで学習しアンサンブル。
    - **Matcha:** `is_vqa=False`設定。数値の小数点以下桁数を範囲に基づき調整。ヒストグラムを別タイプとして学習。Chart Type予測の補助損失追加。Model Soupで複数チェックポイントを平均化。
    - **Scatter/Dotパイプライン:** YOLOXでマーカー検出（m/lアンサンブル）。CACHEDで軸ラベル/メモリ検出。vietocrでOCR。検出結果から座標を補間。Dotは高さから値を補間。
    - **その他:** ICDARデータでMatcha/分類器を再学習（ルール変更後）。

**4位**

- **アプローチ:** 2段階パイプライン。Scatterは物体検出ベース、その他はDeplot。自作合成データによる頑健性向上が特徴。
- **アーキテクチャ:** Scatter: YOLOX (プロット領域検出、点検出)、Matcha (軸ラベルOCR)。その他: Deplot。
- **アルゴリズム:** 物体検出(YOLOX)。OCR。
- **テクニック:**
    - **データ:** 競技データ、ICDARデータ、Brendan氏公開データ、自作合成データ（matplotlib使用、線がTick上にない場合、JPG圧縮、特殊記号、微小値の桁拡張、複数行ラベルなど困難なケースを再現）。
    - **Scatterパイプライン:** YOLOXでプロット領域BBox検出→BBox内をクロップ→YOLOXで点検出→Matchaで最大/最小軸ラベルをOCR→点座標計算。
    - **Deplot学習:** 複数データソースをエポックごとにランダムサンプリングして学習。
    - **合成データ:** 抽出データやICDARデータでのエラー分析に基づき、モデルが苦手とするパターンを重点的に生成。

**5位**

- **アプローチ:** 3段階Matcha学習パイプラインと、Scatter用の物体検出/OCRベースの別プロセス。自作合成データ活用。
- **アーキテクチャ:** 分類/系列予測(Bar/Line/Dot): Matcha-base。Scatter: CACHED (領域/ラベル検出), MobileNetV2 (テキスト回転角分類), vietocr (OCR, ResNeXt50 Encoder), MaskRCNN (CoAt Backbone, 点検出)。
- **アルゴリズム:** Adafactor Optimizer, Cosine Scheduler w/ Warmup。物体検出、OCR、セグメンテーション。
- **テクニック:**
    - **データ:** 競技データ、ICDARデータ、自作合成データ（chart-synthesizerベース、エラーバー、ヒストグラム、困難な線グラフパターン、Blur/Noise効果など）。
    - **Matcha学習:** 3段階学習 (Stage 1: 分類器として学習、Stage 2: 全タイプ系列抽出、Stage 3: タイプグループ別ファインチューニング)。Encoderの一部を凍結。
    - **ターゲット形式:** `<chart_type><start>x1|y1;…;xn|yn<end>`。ヒストグラムは別タイプ扱い。動的丸め処理。
    - **Scatterパイプライン:** CACHEDでプロット領域と軸ラベルBBox検出→MobileNetV2でテキスト回転角分類→vietocrでOCR→MaskRCNNで点検出→各結果から座標値を推定。

**6位**

- **アプローチ:** Deplotをベースとし、Scatterに対してUNetによる点セグメンテーションを用いた後処理を追加。外部データと疑似ラベルを活用。
- **アーキテクチャ:** 系列予測: Deplot。Scatter後処理: UNet (EfficientNet-B7 Encoder)。
- **アルゴリズム:** CrossEntropy Loss。NMS。Greedy Decoding。
- **テクニック:**
    - **データ:** 競技データ（抽出データ全体、生成データの一部）、外部データ（PubMed記事のグラフ、疑似ラベル＋手動修正）、Brendan氏公開データ（事前学習用）。
    - **Deplot学習:** 数値の丸め処理（Tickラベルに基づき約5バケット）。ターゲット形式は`<key>;<value>|...`。リバースシーケンスを学習する補助Decoder/損失。Pixel Dropout Augmentation。
    - **Scatter後処理:** UNetで点をセグメンテーション（ターゲットは点中心のガウシアン）。NMSで予測点数を取得。Deplotの予測データ点数がUNet予測と異なる場合、過剰分を削除、不足分を平均値で補完。
    - **アンサンブル:** 4シードのDeplot予測 + UNet後処理。Deplotはデコーダー予測の内部アンサンブル（Greedy Decodingステップごと）。

**7位**

- **アプローチ:** エンドツーエンドモデルではなく、複数の特化モデル（分類、テキスト検出、OCR、物体検出、セグメンテーション）を組み合わせたパイプライン。競技データのみ使用。
- **アーキテクチャ:** 分類: EfficientNetV2s。テキスト検出/認識: 不明(カスタム?)。物体検出(メモリ/点/バー): YOLO系(推定)。セグメンテーション(線/バー): UNet系(推定)。
- **アルゴリズム:** 物体検出、OCR、セグメンテーション、後処理ルール。
- **テクニック:**
    - **パイプライン:** ①タイプ分類 → ②軸ラベル検出(Text Detection) → ③軸ラベル認識(Text Recognition) → ④軸メモリ検出(Object Detection) → ⑤ラベルとメモリのマッピング → ⑥データ要素検出（Bar: 上端検出、Line: 線セグメンテーション、Scatter: 点検出）→ ⑦座標値計算。
    - **後処理:** 軸ラベルの単調増加性を利用したエラー補正、OCRのための単語分割・並び替え。ヒストグラム判定（バーセグメンテーション結果の水平方向占有率）。水平棒グラフは90度回転＋反転で垂直棒グラフとして処理。
    - **データ:** 競技データのみ。抽出データをTrain/Validation 50/50に分割。最終モデルは全データで学習。

