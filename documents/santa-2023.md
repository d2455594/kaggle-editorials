---
tags:
  - Kaggle
  - 組合せ最適化
  - ビームサーチ
startdate: 2023-12-19
enddate: 2024-02-01
---
# Santa 2023 - The Polytope Permutation Puzzle
[https://www.kaggle.com/competitions/santa-2023](https://www.kaggle.com/competitions/santa-2023)

**概要 (Overview)**

* **目的:** このコンペティションの目的は、3種類のパズル（Cube: ルービックキューブ風、Globe: 球体状、Wreath: リング状）について、それぞれランダムにシャッフルされた初期状態から指定された目標状態（解けた状態）に戻すための**最短手数の操作シーケンスを見つける**ことです。
* **背景:** 毎年恒例となっているKaggleの年末Santaコンペティションの一環です。今回は、置換群や組み合わせ最適化、パズル解法アルゴリズムに関する知識や探索戦略が鍵となる問題設定でした。
* **課題:** 各パズルタイプには独自の操作ルールがあり、これらの操作を組み合わせて解を見つける必要があります。特にパズルのサイズが大きくなると、状態空間が爆発的に増加するため、単純な探索アルゴリズムでは現実的な時間内に解を見つけること、ましてや最短手数の解を見つけることは非常に困難です。効率的な探索戦略や、問題構造を利用したヒューリスティクス、特定の操作パターン（コンボ）の発見と活用が求められました。

**データセットの形式 (Dataset Format)**

提供される主なデータは、パズルの定義と初期状態/目標状態です。

1.  **`puzzles.csv`**:
    * 各パズルのインスタンスに関する情報が含まれるCSVファイル。
    * `id`: 各パズルを一意に識別するID。
    * `puzzle_type`: パズルの種類とサイズを示します。
        * `cube_N/N/N`: N×N×Nの立方体パズル。
        * `globe_M/N`: M行N列の球体パズル（Mは行数、Nは1行あたりのピース数で偶数）。
        * `wreath_N/N`: N×Nのリング状パズル。
    * `solution_state`: パズルの目標状態。各ピースの色やIDがセミコロン区切りで記述されています。
    * `initial_state`: パズルの初期状態（シャッフルされた状態）。形式は`solution_state`と同じ。
    * `num_wildcards`: `wreath`タイプのパズルでのみ使用され、任意の色として扱えるワイルドカードピースの数を示します。
2.  **`puzzle_info.json`**:
    * 各`puzzle_type`で許可されている操作（Move）とその操作が状態にどのように影響するかの定義が含まれるJSONファイル。
    * 例えば、`cube_N/N/N`タイプでは、特定の面 (Front, Right, Down) の特定の深さ(`k`)の層を90度回転させる操作 (`f<k>`, `r<k>`, `d<k>`) と、その逆操作 (`-f<k>`, `-r<k>`, `-d<k>`) が定義されています。
    * `globe_M/N`タイプでは、特定の行 (`r<k>`, `-r<k>`) や半球 (`f<k>`, `-f<k>`) を回転させる操作があります。
    * `wreath_N/N`タイプでは、左右のリングを回転させる操作 (`l`, `-l`, `r`, `-r`) があります。
3.  **`sample_submission.csv`**:
    * 提出フォーマットのサンプル。`id`（パズルID）と`moves`（操作シーケンスをドット区切りで記述）の列を持ちます。

**評価指標 (Evaluation Metric)**

* **指標:** **総手数 (Total Moves)**
* **計算方法:**
    1.  提出された各パズルの解（操作シーケンス）が、与えられた`initial_state`を正しく`solution_state`に変換するかどうかが検証されます。無効な解（解けない、またはルール外の操作を含む）はスコア計算から除外されます。
    2.  有効な解について、操作シーケンスに含まれる操作の総数をカウントします。
    3.  コンペティションの最終スコアは、解けたすべてのパズルに対する操作手数の合計値です。
* **意味:** パズルを解くために必要な操作の総ステップ数を評価します。より少ない手数で解ける解法が優れているとされます。スコアは**低い**ほど良い評価となります。

---

**全体的な傾向**

この組み合わせ最適化問題では、広大な状態空間から最短経路を見つけるために、多くのチームが**交換子 (Commutator)** や**共役 (Conjugate)** の概念に基づいたアプローチを採用しました。特に重要なのは、ごく少数のピース（典型的には3つ）の位置のみを変更し、他の大部分のピースには影響を与えない短い操作シーケンス（**3-cycle**、**コンボ**、**3-rot** と呼ばれる）を発見し、活用することでした。

これらの「コンボ」の探索には、**幅優先探索（BFS）** や**深さ優先探索（DFS）** が用いられ、事前計算である程度の長さまでの有効なコンボがリストアップされました。

実際の解探索フェーズでは、**ビームサーチ (Beam Search)** や**貪欲法 (Greedy Search)** が中心的な役割を果たしました。これらのアルゴリズムは、現在の状態から、事前に計算されたコンボや基本操作を適用して、目標状態に最も近づく（例: 目標状態とのハミング距離が最小になる）状態遷移を選択的に探索します。単純にシーケンスの末尾に操作を追加するだけでなく、シーケンスの**途中にコンボを挿入**する戦略が有効でした。これは、より多様なコンボを適用可能にし、さらに操作の**キャンセル**（例: `f0` の後に `-f0` が続く場合など）を引き起こして手数を削減する効果が期待できるためです。共役 (`q.f.q^-1`) の考え方を利用して、途中挿入時の操作計算を効率化するテクニックも用いられました。

パズルタイプごとに固有の戦略も重要でした。
* **Cube:** コーナー、エッジ中央、面中央といった特殊なピースを先に固定し、残りのピースを構造的な対称性に基づいてクラスタに分割し、主に3-cycleコンボを用いて解くアプローチが主流でした。辺ピースやコーナーピースに関する**パリティ（偶奇性）** の問題を解決する必要がありました。最終段階では、標準的な3x3x3や4x4x4のソルバーが利用されました。
* **Globe:** Cubeと同様にコンボ（3-cycleや4-cycle）が利用されました。こちらもパリティ問題への対処が必要でした。特に全ピースの色が異なる難しいケースでは、任意の3ピースを交換するコンボを体系的に生成・適用するアプローチが取られました。
* **Wreath:** 小さなサイズの問題に対しては、**双方向探索（Bi-directional BFS）** で最適解を求めることが可能でした。大きなサイズ、特にワイルドカードが存在する問題では、特定のアルゴリズム（ハンガリアンパズルの解法に類似）や、探索深さを確保するための工夫を凝らしたビームサーチやDFSが用いられました。

**各解法の詳細**

**[1位](https://www.kaggle.com/competitions/santa-2023/discussion/472405)**

* **アプローチ:** CubeとGlobeに注力（Wreathは単純なビームサーチで十分短いため低優先度）。基本戦略は、少数のピースのみを動かす操作シーケンス（特に3-cycle、**3-rot**）を発見・利用すること。
* **アーキテクチャ/アルゴリズム:**
    * **3-rot探索:** BFSや双方向探索を用いて、短い手数（Cubeは最長14手）の3-rotを事前計算。Globeでは、特定の3-rot `R` を基本とし、任意の3ピース `(i, j, k)` を `R` が適用できる位置に移動させる操作 `A` をBFSで見つけ、`A.R.-A` の形で任意の3-rotを構成。
    * **解探索:**
        1. 特殊パーツ（Cubeのコーナー等、Globeの奇数行中央列等）を解く。
        2. 残りのクラスタが偶置換になるように調整（3-rotは偶置換のため）。
        3. 各クラスタを3-rotで独立に解く。
    * **最適化:** 単純な3-rot適用だけでなく、基本操作や短いシーケンスである程度揃えてから3-rotで仕上げる。操作シーケンスの**途中**に3-rotを挿入し、キャンセル効果やより短いコンボの利用を狙う。
* **テクニック:**
    * **Cube:** コーナー、面中央、エッジ中央以外は、対称性を考慮していくつかの代表的なクラスターについて3-rotを列挙。
    * **Globe:** 奇数行の場合の中央列以外は、任意の3-rotが存在することを利用。
    * **途中挿入:** シーケンス `a[0]...a[T-1]` の時刻 `t` に `B'` を挿入する (`a[0]...a[t-1].B'.a[t]...a[T-1]`) ことが、末尾に共役 `A'.B.(A')^-1` (ここで `A' = a[t]...a[T-1]`) を追加することと等価であることを利用し、最適な挿入時刻 `t` を選択する。

**[2位](https://www.kaggle.com/competitions/santa-2023/discussion/476997)**

* **アプローチ:** CubeとGlobeでは、少数のピース（3つまたは4つ）のみを動かす短い操作シーケンス（**コンボ**）の利用と、シーケンスの途中へのコンボ挿入による段階的な最適化。Wreathは小サイズは双方向探索、大サイズ（ワイルドカード付き）は特定アルゴリズム。
* **アーキテクチャ/アルゴリズム:**
    * **コンボ探索:** 最大8手までのシーケンスを網羅的に探索し、3ピースまたは4ピースのみを動かすコンボを発見。
    * **解探索 (Cube/Globe):** 貪欲探索またはビームサーチ。初期シーケンス（空）から開始し、基本操作またはコンボをシーケンスの任意の位置に挿入して、ミスマッチ数を繰り返し削減。
    * **Wreath (小):** 双方向BFS。状態を128bit整数でエンコード。
    * **Wreath (大):** ハンガリアンパズルに似た特定アルゴリズム。左右リングの交差点を使い、ピースの色を段階的に修正。ランダム化と繰り返しにより手数削減。
* **テクニック:**
    * **途中挿入の効率化:** シーケンス `m1...mn` の途中に `f` を挿入することは、末尾に共役 `f' = (mn...m(i+1)).f.(mn...m(i+1))^-1` を追加することと等価。`mn`, `m(n-1).mn`, ... とその逆操作を事前に計算しておくことで、`f'` の計算を高速化。
    * **Cube:**
        * エッジピースの色を隣接ピースに基づき再定義。
        * 特殊パーツ（中心ピース、パリティ）の解決。辺ピースの3Dピースとしての偶奇性、辺中央ピースの偶奇性、未解明なパリティ（表面2回転の組み合わせで解決）に対処。
        * 24/48ピース問題への分割：対称性からピースが特定のグループ内でのみ移動することを利用し、グループごとに独立してコンボを適用して解く。
        * 最終段階は3x3x3または4x4x4ソルバーを使用。
    * **Globe:** パリティ解決（r0, r(k-1)操作とfi操作の偶奇性に基づく）。特定インスタンス（391, 395）では、任意の3ピース回転コンボを網羅的に適用して解く。
    * **Wreath (大):** 交差点の色をBに統一する簡略化。インデックス26ずつの巡回的な修正順序。ランダムな事前修正ステップによる手数削減。

**[3位](https://www.kaggle.com/competitions/santa-2023/discussion/476792)**

* **アプローチ:** 全てのパズルタイプ（Cube, Globe, Wreath）に共通の**ビームサーチ**戦略を採用。状態遷移には、少数のピースのみを動かす事前計算された操作シーケンス（DFS/BFSで生成）を主に使用。
* **アーキテクチャ/アルゴリズム:**
    * **コンボ探索:** DFS（最大9-10手）とBFSで少ピース変更シーケンスを事前計算。重複除去（最短手数、辞書順最小）。共役 (`A.X.-A`) を用いたシーケンス拡張。
    * **解探索:** ビームサーチ。評価関数は目標状態とのハミング距離（解きにくいピースの重み付けあり）。
    * **Wreath (大):** ビームサーチ + 評価関数としての深さ制限付きDFS。
* **テクニック:**
    * **ビームサーチ高速化:** スコア計算の効率化、マルチスレッド化（180スレッド）。
    * **コンボ適用:** 状態遷移に事前計算コンボを使用。逆操作によるキャンセル処理。
    * **Cube:** 面とエッジを分離してビームサーチで解き、最後に3x3ソルバー（QTM最適化版）を使用。エッジのパリティ調整はルールベースで別途実施。「並列化」遷移（例: `f0.r2.b0` から `f0.r2.r1.b0` へ）を追加。
    * **Globe:** ビームサーチは2行単位で独立に解き、後で結合。結合時に操作の「並列化」による手数削減をDPで最適化。全ピース色違い問題ではパリティ調整後に偶数長のコンボのみを使用。
    * **Wreath (大):** 探索深度を確保するため、状態に応じて使用可能な操作を制限するヒューリスティクス（交差点の色に基づく）。評価関数計算のためのDFS探索深度を50まで拡張。
