---
tags:
  - Kaggle
  - パーキンソン病
  - ヘルスケア
  - SMAPE
  - LightGBM
startdate: 2023-02-17
enddate: 2023-05-19
---
# AMP®-Parkinson's Disease Progression Prediction
[https://www.kaggle.com/competitions/amp-parkinsons-disease-progression-prediction](https://www.kaggle.com/competitions/amp-parkinsons-disease-progression-prediction)

**概要 (Overview)**

* **目的:** このコンペティションの目的は、Accelerating Medicines Partnership® Program Parkinson’s Disease (AMP® PD) によって収集されたデータを用いて、パーキンソン病患者の**症状進行度（Unified Parkinson's Disease Rating Scale, UPDRSスコア）を将来にわたって予測する**機械学習モデルを開発することです。臨床データに加え、血液サンプルから得られたプロテオミクス（タンパク質）およびペプチドミクス（ペプチド）データ、投薬情報などが利用可能です。
* **背景:** パーキンソン病は進行性の神経変性疾患であり、症状の進行速度は患者ごとに大きく異なります。将来の症状進行をより正確に予測できれば、個別化された治療介入や、新薬開発のための臨床試験の設計・効率化に大きく貢献できます。AMP® PDは、データ共有と分析を通じてパーキンソン病研究を加速させることを目指しており、本コンペもその一環として位置づけられています。
* **課題:** 患者ごとの longitudinal（縦断的）な臨床データ（UPDRSスコア、投薬情報）と、高次元なバイオマーカーデータ（プロテオミクス、ペプチドミクス）を統合し、**数ヶ月から2年先の4種類のUPDRSスコアを予測**するという、複雑な**時系列マルチモーダル予測タスク**です。データには欠損値が多く、特にバイオマーカーデータはノイズが多く、サンプル数（患者数）に対して特徴量数が膨大であるため（**次元の呪い**）、バイオマーカーから安定した予測シグナルを見つけ出すことが非常に困難でした。また、評価指標であるSMAPE+1の最適化も考慮が必要でした。

**データセットの形式 (Dataset Format)**

提供される主なデータは、臨床訪問記録、プロテオミクスデータ、ペプチドミクスデータです。

1.  **`train_clinical_data.csv`**:
    * 患者ごとの複数回の臨床訪問記録。
    * `visit_id`: 訪問を一意に識別するID (`patient_id`_`visit_month`)。
    * `patient_id`: 患者ID。
    * `visit_month`: ベースラインからの経過月 (0, 6, 12, 18, 24, ...)。
    * `updrs_1`, `updrs_2`, `updrs_3`: UPDRSのPart 1（非運動症状の日内変動）、Part 2（日常生活動作）、Part 3（運動機能検査）のスコア。これらが主要な予測ターゲット。
    * `updrs_4`: UPDRSのPart 4（治療の合併症）のスコア。一部欠損があり、予測は任意だがスコア計算には含まれる。これも予測ターゲット。
    * `upd23b_clinical_state_on_medication`: UPDRS Part 3評価時の投薬状態（On/Off/不明）。
2.  **`train_proteins.csv`**:
    * 各訪問時 (`visit_id`) の血液サンプルから測定された約230種類のタンパク質の正規化存在量 (NPX: Normalized Protein eXpression)。
    * `UniProt`: タンパク質のID。
    * `NPX`: 正規化されたタンパク質量。欠損値あり。
3.  **`train_peptides.csv`**:
    * 各訪問時 (`visit_id`) の血液サンプルから測定された約1000種類のペプチドの存在量 (PeptideAbundance)。
    * `UniProt`, `Peptide`: タンパク質IDとペプチド配列。
    * `PeptideAbundance`: ペプチド存在量。欠損値あり。
4.  **`supplemental_clinical_data.csv`**:
    * 追加の臨床データ。形式は`train_clinical_data.csv`と同様。分布が異なる可能性あり。
5.  **テストデータとAPI:**
    * コンペ期間中は**タイムシリーズAPI**を通じてデータが提供されました。
    * APIは、テスト対象となる患者の過去の臨床データ、プロテイン/ペプチドデータ、現在の投薬情報を段階的に提供します。
    * 参加者は、提供された情報に基づき、指定された将来の時点（現在の訪問月から+6ヶ月、+12ヶ月、+24ヶ月など）における4つのUPDRSスコアを予測し、提出する必要がありました。
6.  **`sample_submission.csv`**:
    * 提出フォーマットのサンプル。
    * `prediction_id`: 予測を一意に識別するID（例: `VISIT_ID_UPDRS_TYPE_plus_MONTHS`）。
    * `rating`: 予測したUPDRSスコア。
    * `group_key`: 予測が行われた時点の訪問月 (`visit_month`)。

**評価指標 (Evaluation Metric)**

* **指標:** **SMAPE+1 (Symmetric Mean Absolute Percentage Error plus one)**
* **計算方法:** 各予測ターゲット（4つのUPDRSスコア × 複数の将来予測時点）について、予測値 (`F`) と真の値 (`A`) を用いて以下の式で計算し、その平均を取ります。
    * SMAPE+1 = (1/N) * Σ [ 2 * |F_i - A_i| / (|F_i + 1| + |A_i + 1|) ]
    （Nは評価対象となる全予測の数）
* **意味:** 予測誤差の絶対値を、予測値と真の値の平均的な大きさ（ゼロ除算を避けるため1を加算）で正規化したものです。パーセンテージ誤差に似ており、スケールの異なるターゲット（UPDRS 1〜4）に対しても比較的公平な評価が可能です。分母に+1があるため、値が0に近い場合の誤差が過大評価されにくくなっています。スコアは**低い**ほど良い評価となります。

---

**全体的な傾向**

このコンペティションでは、**患者の訪問パターンに関する特徴量エンジニアリング**が最も重要であり、上位解法の成否を分ける鍵となりました。一方で、期待された**プロテオミクスやペプチドミクスといったバイオマーカーデータは、予測精度の向上にほとんど寄与しない**、あるいはノイズとして働くことが多くのチームによって報告されました。これは、データのノイズレベルの高さや、サンプル数に対する特徴量の多さ（次元の呪い）が原因と考えられます。

**訪問履歴ベースの特徴量**としては、単純な訪問月 (`visit_month`) や予測対象月 (`prediction_month`) に加え、**特定の月（特に6ヶ月目や18ヶ月目）に訪問があったかどうか**を示すフラグが極めて有効でした。これは、早期（6ヶ月目など）に追加の診察が必要な患者は、症状が重い、または進行が速い傾向があることを反映していると推測されます。患者を訪問パターン（例: 6ヶ月訪問あり/なし、初回訪問が0ヶ月か否かなど）に基づいて**グループ分け**し、グループごとにモデルを構築したり、予測値を調整したりするアプローチが成功を収めました。

モデルとしては、**LightGBM (LGB)** やシンプルな**多層パーセプトロン (MLP)**、**サポートベクター回帰 (SVR)** などが用いられました。LGBでは、回帰問題として直接解くよりも、ターゲット値を離散化して**分類問題**として扱い、予測された確率分布からSMAPE+1を最小化する整数値を探索するアプローチが有効でした。NN (MLP) では、**SMAPE+1を直接損失関数として最適化**する手法が取られました。

データの構造上、各患者の各訪問に対して複数の将来時点の予測を行う必要があるため、データ形式を**ロングフォーマット**（1行が1つの予測ターゲットに対応）に変換して処理するのが一般的でした。

交差検証 (CV) は、患者数が少ないため難しく、**Leave-One-Patient-Out (LOPO) CV** や、患者IDに基づく **GroupKFold** が主に用いられました。しかし、CVスコアとPublic/Private LBスコアの相関は必ずしも高くなく、LBプロービングがある程度有効な状況でした。

最終的な予測は、複数のモデル（LGB, NNなど）や異なる設定で学習されたモデルの予測値を**アンサンブル**（単純平均、重み付き平均など）することで安定性と精度が向上しました。

**各解法の詳細**

**[1位](https://www.kaggle.com/competitions/amp-parkinsons-disease-progression-prediction/discussion/411505)**

* **アプローチ:** LightGBM（分類として定式化）とNN（回帰、SMAPE+1損失）の単純平均アンサンブル。バイオマーカーデータは完全に無視。
* **アーキテクチャ:** LGBM, MLP。
* **アルゴリズム:** LGBM: 多クラス分類 (LogLoss)。NN: 回帰 (SMAPE+1 Loss)。
* **テクニック:**
    * **特徴量:** `visit_month`, 予測期間, 予測対象月, 血液検査有無フラグ, supplementaryデータフラグ, **特定の月(6, 18, 48ヶ月目)の訪問有無フラグ**, 以前の非年間訪問回数, ターゲットインデックス。
    * **LGBM:** ターゲット値 (0-86) をクラスラベルとする分類問題として学習。推論時に予測確率分布からSMAPE+1を最小化する整数値を探索して最終予測値とする。
    * **NN:** シンプルなMLP。最終層にLeakyReLUを使用し負の予測値を防止。
    * **CV:** Leave-One-Patient-Out (LOPO) CV。
    * **アンサンブル:** LGBMとNNの予測値を単純平均。

**[2位](https://www.kaggle.com/competitions/amp-parkinsons-disease-progression-prediction/discussion/418143)**

* **アプローチ:** 訪問月関連の特徴量を重視したMLPモデルのアンサンブル。異なるターゲット構造（16ラベル vs 4ラベル）のモデルを組み合わせ。
* **アーキテクチャ:** MLP。
* **アルゴリズム:** 回帰。損失関数はMAE? MSE?
* **テクニック:**
    * **データ選択:** 特定の訪問月 (0, 6, 12, 18, 24, 36, 48, 60, 72, 84) のデータのみを学習に使用。
    * **特徴量:** 訪問月関連（訪問月自体、前回訪問からの経過月、訪問回数）。プロテインデータは患者ごとのNPX値の比率を使用（元の値より有効だった）。
    * **モデル構造:** 2種類のターゲット構造でモデルを学習。
        * 16ラベル: 各UPDRS x 各予測期間 (0, 6, 12, 24) の16ターゲットを同時に予測。
        * 4ラベル: 予測期間を特徴量として入力し、4つのUPDRSターゲットを予測。
    * **アンサンブル:** 上記2種類の構造、異なるネットワーク構造、異なるパラメータで学習した複数のMLPモデルをブレンド。

**[3位](https://www.kaggle.com/competitions/amp-parkinsons-disease-progression-prediction/discussion/411546)**

* **アプローチ:** 患者を訪問パターン（6ヶ月/18ヶ月訪問有無）で2グループに分け、それぞれ最適化した線形回帰係数を適用。グループ分けと係数調整にバイオマーカー情報由来のラベルを使用。
* **アーキテクチャ:** 線形回帰ベースのルールベースシステム。
* **アルゴリズム:** 線形回帰 + グリッドサーチによる係数最適化。
* **テクニック:**
    * **グループ分け:** 患者を訪問間隔の最小値に基づき2グループ（A: 12ヶ月以上 = Healthy?, B: 6ヶ月以下 = Unhealthy?）に分類。**6ヶ月目だけでなく18ヶ月目の訪問有無も考慮**。
    * **追加ラベル生成:** Unhealthyグループ（Group B）内で、プロテイン収集頻度やUniProt種類数、ペプチド変化量などに基づいて、さらに9段階の「重症度」ラベルを生成。
    * **モデリング:** 最終的にはLGBMは使用せず。ベースとなる予測（おそらく単純な線形トレンドなど）に対し、上記で生成した9種類のラベル（特徴量）に基づいて予測値を補正する係数をグリッドサーチで決定。
    * **係数決定:** TrainデータとPublic LBデータ（Train+LB = 298患者）の両方でスコアが改善する場合のみ、そのラベルに基づく補正を採用（頑健性重視）。

**[4位](https://www.kaggle.com/competitions/amp-parkinsons-disease-progression-prediction/discussion/411398)**

* **アプローチ:** 患者の訪問日情報から生成した特徴量を用いた単一モデル（SVRまたはMLP）。バイオマーカーデータは不使用。
* **アーキテクチャ:** RAPIDS cuML SVR, TensorFlow MLP (10層x24ユニット, ReLU)。
* **アルゴリズム:** SVR (epsilon-insensitive loss?), MLP (MAE Loss)。
* **テクニック:**
    * **特徴量エンジニアリング:** 患者の訪問頻度とUPDRSスコアの相関に着目。**各訪問月(0, 6, ..., 84)の訪問有無を示すブール変数(`v0`, `v6`, ...)** を生成。訪問の有無が不明な将来時点については `-1` を設定。最終的には `visit_month` とこれらのブール変数10個の計11特徴量を使用。
    * **モデル:** RAPIDS cuML SVR (CV 55.5, Private 60.5) または TensorFlow MLP (CV 55.0, Private 60.1)。MLPの方がわずかに高性能。
    * **データ作成:** 元データを各訪問に対して4つの将来予測時点 (0, 6, 12, 24ヶ月後) の行に変換し、その際の既知の訪問有無フラグを特徴量として設定。
    * **シグナル源:** プロテイン/ペプチドデータにはランダムノイズと同程度の予測力しかなく、訪問日情報が主要なシグナル源であると判断。

**[5位](https://www.kaggle.com/competitions/amp-parkinsons-disease-progression-prediction/discussion/411388)**

* **アプローチ:** 患者を訪問パターンで「コントロール群」（12ヶ月間隔訪問）と「真の患者群」（6ヶ月間隔訪問あり）に分け、グループごとに線形回帰またはIsotonic Regressionを適用。
* **アーキテクチャ:** 線形回帰、Isotonic Regression。
* **アルゴリズム:** 線形回帰、Isotonic Regression。
* **テクニック:**
    * **コントロール群の特定:** 患者ごとの**初回非ゼロ訪問月**を計算。これが12ヶ月ならコントロール群、6ヶ月などそれ未満なら真の患者群と判定。
    * **モデリング:** 2つの特徴量（グループ所属、予測対象月）のみを使用。グループごとに線形回帰またはIsotonic Regressionモデルを適用し予測。
    * **洞察:** コントロール群はUPDRSスコアが低く、UPDRS4は測定されない傾向。このグループ分けが予測に非常に有効。

**[8位](https://www.kaggle.com/competitions/amp-parkinsons-disease-progression-prediction/discussion/411395)**

* **アプローチ:** 訪問間隔の最小値で患者をグループ分け（6ヶ月 vs 12ヶ月）し、グループごとに線形回帰の係数を調整。
* **アーキテクチャ:** 区分的線形モデル（Piecewise function）。
* **アルゴリズム:** 線形回帰（切片、傾き、60ヶ月以降の傾き変化の3パラメータ）。グループごとにパラメータを最適化。
* **テクニック:**
    * **グループ分け:** 患者ごとの**最小訪問間隔**を計算し、6ヶ月（True patients）と12ヶ月（Control group）に分類。3ヶ月や36ヶ月は6ヶ月に変換。
    * **モデリング:** 各グループ、各UPDRSターゲットに対し、`y = a + b*month + c*max(0, month-60)` の形の線形トレンドを仮定し、パラメータ(a, b, c)を最適化。UPDRS4は60ヶ月以降はクリップ。
    * **推論:** 初回訪問時はグループ不明なため、全患者で学習した係数を使用。2回目以降の訪問では、計算された最小訪問間隔に基づいてグループを特定し、対応する係数を使用。

**[9位](https://www.kaggle.com/competitions/amp-parkinsons-disease-progression-prediction/discussion/411380)**

* **アプローチ:** 訪問パターンに基づくルールベースの患者分割 + 訪問月のみを特徴量としたモデル（線形回帰、CatBoost）のアンサンブル。
* **アーキテクチャ:** 線形回帰, CatBoost。
* **アルゴリズム:** 線形回帰, CatBoost Regression (Huber Loss, MAE Loss)。重み付き平均アンサンブル。
* **テクニック:**
    * **ルールベース分割:** 6ヶ月目**または**18ヶ月目にデータがない患者（Healthy Patients）を特定し、これらの患者に対しては予測値を低く調整するルールを適用。
    * **学習データ選択:** 上記のHealthy Patientsを除いたデータでモデルを学習。Supplementalデータも使用（一部除外あり）。
    * **モデル:** 単純線形回帰、CatBoost Huber回帰、CatBoost MAE回帰の3種類を学習し、CVスコアが高くなるように重み付き平均。
    * **特徴量:** `visit_month` のみ。
    * **CV:** GroupKFold（ターゲット分布を考慮）。
    * **提出選択:** LBとCVの両方が良いモデル（ルール適用、訪問月のみモデル）を選択。プロテイン/ペプチド特徴量を使ったモデルはCVは良かったがLBが悪化したため不採用。
