---
tags:
  - Kaggle
startdate: 2023-07-27
enddate: 2023-10-16
---
# RSNA 2023 Abdominal Trauma Detection
https://www.kaggle.com/competitions/rsna-2023-abdominal-trauma-detection

**概要 (Overview)**

* **目的:** このコンペティションの目的は、**腹部CT（コンピュータ断層撮影）スキャン画像**を用いて、**外傷による腹部臓器（肝臓、脾臓、腎臓）の損傷、腸管損傷、および血管外漏出（活動性出血）**の有無や重症度を自動的に検出し、分類するモデルを開発することです。
* **背景:** 腹部外傷は交通事故などでよく見られ、迅速かつ正確な診断・治療がなされない場合、生命を脅かす可能性があります。救急医療の現場では、CTスキャンが腹部外傷の診断に不可欠ですが、その読影には専門知識と時間が必要です。AIを用いてこの診断プロセスを支援または自動化することで、診断時間の短縮、見落としの削減、そして最終的には患者の予後改善につながることが期待されます。RSNA（北米放射線学会）が関与しており、臨床的な重要性が高い課題です。
* **課題:** 外傷による損傷はCT画像上では微妙な所見である場合があります。CTスキャンは3次元のボリュームデータであり、モデルは複数スライスにまたがる空間情報を効果的に処理する必要があります。また、肝臓、脾臓、腎臓といった複数の臓器損傷に加えて、腸管損傷や活動性出血といった異なる種類の異常を同時に検出し、さらに一部の臓器については損傷の重症度（例：軽度 vs 高度）まで分類する必要があります。これは、医用ボリュームデータに対する**マルチラベル分類（多ラベル分類）**タスクです。

**データセットの形式 (Dataset Format)**

提供される主なデータは、腹部の3D CTスキャン画像（DICOM形式）と、それに対応する特定の外傷所見の有無や重症度を示すラベルです。

1.  **トレーニングデータ:**
    * `train.csv`: トレーニングデータセットの正解ラベル情報。各行が患者 (`patient_id`) に対応し、**ターゲット変数**となる以下の列などを含みます（例）:
        * `bowel_injury`: 腸管損傷の有無 (0 or 1)。
        * `extravasation_injury`: 血管外漏出（活動性出血）の有無 (0 or 1)。
        * `kidney_low`, `kidney_high`: 腎臓損傷（軽度、高度）の有無 (各 0 or 1)。
        * `liver_low`, `liver_high`: 肝臓損傷（軽度、高度）の有無 (各 0 or 1)。
        * `spleen_low`, `spleen_high`: 脾臓損傷（軽度、高度）の有無 (各 0 or 1)。
    * `train_series_meta.csv`: 各患者スキャン内の個々のCTシリーズ（スライスシーケンス）に関するメタデータ。
    * `dicom-images-train/`: 実際のCTスキャン画像ファイル。標準的な医用画像フォーマットである **DICOM形式** で提供され、通常 `patient_id` や `series_id` ごとに整理されています。

2.  **テストデータ:**
    * `test_series_meta.csv`: テスト用CTシリーズのメタデータ。
    * `dicom-images-test/`: テスト用のCTスキャン画像ファイル（DICOM形式）。
    * テストデータには正解ラベルは含まれません。

3.  **`sample_submission.csv`**:
    * 提出フォーマットのサンプル。通常、行の識別子（例: `patient_id` とターゲットラベル名を組み合わせた `12345_bowel_injury`）と、予測結果 `prediction` の列を持ちます。`prediction` 列には、対応する患者の**各ターゲット（損傷の種類）**に対する**存在確率**（0から1の間の数値）を格納します。

**評価指標 (Evaluation Metric)**

* **指標:** **加重対数損失 (Weighted Log Loss)**（マルチラベル版）
* **計算方法:**
    1.  まず、個々のターゲットラベル（各損傷タイプ）ごとに、予測確率と真のラベル（0 or 1）を用いて対数損失（Log Loss / Cross-Entropy）を計算します。
        * LogLoss = - (y * log(p) + (1 - y) * log(1 - p))
        （y: 真のラベル, p: 予測確率）
    2.  各ターゲットラベルには、臨床的な重要度や発生頻度などを考慮した**重み (weight)** が主催者によって事前に設定されています。
    3.  最終的なスコアは、テストデータセット全体の患者について、各ターゲットラベルの平均対数損失を、そのラベルの重みで**加重平均**したものになります。
        * Score = Σ [ ラベル重み * 平均LogLoss_ラベル ] / Σ [ ラベル重み ]
        （Σは全ターゲットラベルにわたる合計）
* **意味:** 対数損失は、予測確率の精度を評価する指標であり、特に確信度の高い誤った予測（例：実際には損傷があるのに低い確率を予測）に対して大きなペナルティを与えます。加重対数損失を用いることで、臨床的に重要度の高い損傷（例：活動性出血）の予測精度をより重視した評価が可能になります。スコアは**低い**ほど（0に近いほど）、モデルの予測確率がより正確で、臨床的な重要性を考慮した上で較正されている（自信のある予測が正しい傾向にある）ことを示し、性能が良いと評価されます。

要約すると、このコンペティションは、腹部CTスキャンから複数の外傷所見（臓器損傷、腸管損傷、出血）の存在確率を予測するマルチラベル分類タスクです。データはDICOM形式のCT画像と損傷ラベルで構成され、性能は各損傷タイプの予測確率の精度を臨床的重要度で重み付けして評価する加重対数損失（低いほど良い）によって測られます。

---
**全体的な傾向**

上位解法では、腹部CTスキャンから外傷（臓器損傷、血管外漏出）を高精度に検出するために、2.5Dアプローチ（隣接する複数スライスをチャネルとして2D CNNに入力する手法）と、それに続くシーケンスモデル（RNN: LSTM/GRU、Transformer）の組み合わせが主流でした。多くの解法で、最初に3Dまたは2Dのセグメンテーションモデルを用いて肝臓、脾臓、腎臓などの関心臓器領域を特定し、その領域をクロップ（切り出し）してから分類モデルに入力する戦略が取られています。特に血管外漏出（Extravasation）や腸管損傷（Bowel）に対しては、画像レベルのラベルを用いた2段階学習や、専用のモデル構築が行われるケースが多く見られました。CNNのバックボーンとしては、EfficientNetV2、ConvNeXt、MaxViT、CoAtNet、ResNe(X)tなどが多様に用いられています。補助的なセグメンテーション損失の導入や、マルチタスク学習、データ拡張、そして複数モデルのアンサンブルもスコア向上のための重要なテクニックでした。

**各解法の詳細**

**1位 (Team Oxygen)**

- **アプローチ:** 3段階アプローチ。Stage1で3Dセグメンテーション、Stage2で臓器別損傷分類、Stage3で腸管・血管外漏出分類。補助セグメンテーション損失を導入。
- **アーキテクチャ:** Stage1: 3D Segmentation Model (詳細不明)。 Stage2/3: 2D CNN (CoAtNet Lite Medium/Small, EfficientNetV2s) + GRU。セグメンテーション用Decoder (Unetベース, 2D-CNNベース)。
- **アルゴリズム:** BCE Loss (分類), Dice Loss (セグメンテーション), AdamW, Cosine Annealing w/ Warmup。最大値集約 (スライスレベル予測からスタディレベル予測)。
- **テクニック:**
    - **データ前処理:** 3Dセグメンテーションでマスク生成→Studyレベルでクロップ→等間隔96スライス抽出→2.5D化(3ch)。臓器可視度に基づきソフトラベル生成。
    - **補助損失:** CNNバックボーンの特徴マップからマスクを予測しDice Lossを計算、分類損失に加算。
    - **アンサンブル:** 複数Fold、Fullデータ、複数アーキテクチャ、異なる前処理データセット（自作/Theo）で学習したモデルをアンサンブル。Fold内はスライスレベル、モデル間は最大値集約後にアンサンブル。
    - **後処理:** CVスコアに基づくスケーリング係数調整のみ。

**2位**

- **アプローチ:** 2.5D CNN + RNNパイプライン。器官存在分類モデルによるフレームサンプリング。器官別クロップモデルも併用し、最終段のRNNで情報を集約。
- **アーキテクチャ:** 2D CNN (MaxViT_tiny, ConvNeXtV2_tiny)、3D CNN (ResNet18、クロップ用)、2D CNN (CoAtNet_1、クロップ分類用)、RNN (LSTMベース、多入力・分岐構造)。
- **アルゴリズム:** BCE Loss, CrossEntropy Loss, Ranger optimizer, AdamW。カスタムRNN構造（器官別プーリング、独立ロジット）。
- **テクニック:**
    - **データ準備:** 長辺512リサイズ→中央384クロップ、1/2フレーム使用、最大600スタック。
    - **フレームサンプリング:** 高速なEffNetV2で器官存在確率を予測し、ターゲットに応じて意味のあるフレームをサンプリング。
    - **クロップモデル:** 3D ResNet18で器官をクロップし、2D CNN(CoAtNet)+RNNで分類。フレーム数はモデルごとに変更。
    - **RNN集約:** 2Dモデル出力（分類確率、セグメンテーション確率、両者の積）、クロップモデル出力（器官別特徴量）、2Dモデル特徴量のプーリング結果などを入力とし、最終的な分類予測を出力。
    - **Augmentation:** 重度の幾何変換、色変換、CutMix。
    - **アンサンブル:** 複数バックボーン、設定のモデルをアンサンブル（ただしPrivateでは効果薄）。

**3位**

- **アプローチ:** 3Dセグメンテーションで器官クロップ後、2.5D + 3D構造の多様な分類モデルを学習しアンサンブル。
- **アーキテクチャ:** 3D Segmentation (ResNet18, ResNet50)。分類: 2.5D CNN (ConvNeXt, SE_ResNeXt, MaxViT, CaFormer, XCiT) + Pooling/LSTM/GRU。
- **アルゴリズム:** CrossEntropy Loss (マルチクラス、全ターゲット同時予測)。カスタムサンプラー。重み付きアンサンブル。
- **テクニック:**
    - **データ準備/クロップ:** 3Dセグメンテーションマスクを拡張して器官をキューブ状にクロップ（2種類のサイズ）。
    - **モデル多様化:** 画像サイズ、スライス数、ネック構造（Pooling/LSTM/GRU）、クロップサイズ、バックボーン、Augmentation、学習エポック数、ターゲット（全臓器/単一臓器）を変更し多数のモデルを学習。
    - **特殊モデル:** 肝臓モデル（入力にbox_mask追加でノイズ削減）、全臓器モデル（臓器ごとに異なるサイズ/枚数で入力し同時学習、カスタムサンプラー使用）。
    - **事前学習:** 画像レベルの腸管/血管外漏出ラベルで事前学習。
    - **アンサンブル:** 各ターゲットに対してモデルの予測値を重み付き平均。
    - **後処理:** Public Notebookと同様の重み付け調整。

**4位**

- **アプローチ:** 2.5D UNetパイプラインで分類とセグメンテーションをマルチタスク学習。
- **アーキテクチャ:** UNet + Transformer Encoder (Pyramid Vision Transformer V2, MaxViT)。
- **アルゴリズム:** CE Loss (Metric準拠の重み付け)。
- **テクニック:**
    - **データ準備:** TotalSegmentatorマスク + 自前2Dマスクモデル。DICOMリサンプリング(1,1,5)。スライスサンプリング(N=14)。Bodyマスクで領域外除去、臓器マスクでZ軸範囲制限。
    - **モデル:** UNetにPVT V2またはMaxViTエンコーダーを統合。
    - **事前学習:** 2Dマスク予測タスクで事前学習。
    - **アンサンブル:** 異なるエンコーダーモデルのアンサンブル。
    - **後処理:** CVスコアに基づくスケーリング係数調整。

**6位**

- **アプローチ:** 臓器タイプ（Organ, Bowel, Extra）別にモデルを構築。Organ/Bowelは3Dセグメンテーション→クロップ→2.5D CNN+LSTM。Extraは2段階（CNN特徴抽出→GRU）。
- **アーキテクチャ:** 3D Segmentation (ResNet18d)。Organ/Bowel: 2.5D CNN (EfficientNetV2s, SEResNeXt50) + LSTM。Extra: CNN (SEResNeXt50, EfficientNetV2s) + GRU。Extra用Segmentation Head。
- **アルゴリズム:** BCE Loss (詳細不明)。
- **テクニック:**
    - **データ準備:** Theo氏のデータセット利用。Patient IDベース5-Fold。
    - **Organ/Bowel:** 3Dセグメンテーション後、器官クロップ（Organ:15枚, Bowel:30枚）。2.5D入力（中心スライス、5ch: n-2～n+2）。
    - **Extra:** スライス抽出（stride 5）、2.5D入力（5ch）。2段階学習（1. 特徴抽出CNN、2. GRUシーケンスモデル）。Ian氏のbboxラベルをセグメンテーションHeadの学習に利用し精度向上。
    - **学習:** Bowel/Extraは画像レベルラベルも利用。

**7位**

- **アプローチ:** 2.5Dパイプライン。シーケンスサンプリングとクロップ/リサイズ。カスタムHead構造。
- **アーキテクチャ:** Backbone: InternImage (Base)。 Neck: UNet++。 Head: Mask2Former風Attention Decoder Head（臓器別）、画像レベル補助学習付きExtravasation Head。
- **アルゴリズム:** CrossEntropy Loss (Metric準拠の重み付け)。
- **テクニック:**
    - **データ準備:** シーケンスサンプリング（T=24/32/48）。有効ピクセルに基づきクロップ、[256, 384]にリサイズ。TotalSegmentatorマスク利用（補助学習用）。
    - **モデルHead:** 臓器用HeadはMask2Formerを参考に、クエリから予測したマスクをAttentionに利用。Extravasation用Headは画像レベルラベルで補助学習。
    - **アンサンブル:** 同一アーキテクチャで、異なるシーケンス長(T)とFoldで学習したモデルを平均化。

**8位**

- **アプローチ:** 臓器タイプ別に3つの2.5D CNN+Transformerモデルを構築（Solid organ, Bowel, Extravasation）。
- **アーキテクチャ:** CNN (ConvNeXt-tiny, MobileNetV3_small)。 Transformer (3層)。
- **アルゴリズム:** Weighted BCE Loss (Metric準拠)。Softmax活性化、Sqrtスケーリング。
- **テクニック:**
    - **データ準備:** DICOMを3ch Window PNGに変換。クロップモデル(MobileNetV3)で黒領域除去。臓器同定モデル(MobileNetV3)使用。
    - **Solid Organ:** 自作スライスレベル損傷ラベルで2D CNN学習→特徴抽出(128スライス x 256次元)。Transformerで系列レベル予測。
    - **Bowel:** 提供されたスライスレベルラベルで同様にCNN+Transformer学習。
    - **Extravasation:** 自作BBoxラベルからパッチ(128x128)を作成しCNN学習→パッチ特徴抽出。Transformerでスライスレベル特徴抽出。さらにTransformerで系列レベル予測。
    - **アンサンブル:** 5-Foldアンサンブル。
    - **後処理:** 系列間で予測値を平均化。Softmax適用後、全確率を平方根でスケーリング。

**9位**

- **アプローチ:** 3Dセグメンテーションで器官クロップ後、臓器別に2.5D分類モデル（SEResNeXt→LSTM→[CNN+Attention]）を学習。Bowel/Extravasationは2段階学習。
- **アーキテクチャ:** 3D Segmentation (ResNet18d, UNet)。分類: SEResNeXt + LSTM + [1D CNN, Attention]。
- **アルゴリズム:** Weighted Loss (Metric準拠)。
- **テクニック:**
    - **データ準備:** 低HU系列選択（複数ある場合）。Cuboid Crop（マスク拡張あり）。4ch入力（i-1, i, i+1, mask）。
    - **モデル:** 肝臓/腎臓/脾臓は単一モデルで同時分類。
    - **Bowel/Extravasation:** 2段階学習（1st: 画像レベルラベルで2D CNN学習、2nd: 1st Stageの特徴量をLSTMに入力し系列レベル学習）。Extravasationは高HU系列使用、高解像度入力。
    - **後処理:** OOF予測値に基づき探索した係数を乗算。

**10位**

- **アプローチ:** 3Dセグメンテーション（SwinUNETR）＋臓器別2.5D CNN+LSTMモデル。Bowel/Extravasationはセグメンテーションなし。スタッキングモデル（MLP）で最終化。
- **アーキテクチャ:** Segmentation: MONAI SwinUNETR。分類: 2.5D CNN (ResNetRS50など) + LSTM/BiGRU (Attention Pooling/Max Pooling)。スタッキング: MLP (4層)。
- **アルゴリズム:** Weighted LogLoss, Focal Loss。
- **テクニック:**
    - **データ準備:** セグメンテーション前に全体リサイズ(128^3)。臓器クロップ後リサイズ。Extravasationは黒領域除去後リサイズ(384^2)。
    - **Bowel/Extravasation:** 2段階学習（1st: 画像レベルCNN、2nd: 系列レベルBiGRU）。画像レベル特徴量はstride=3で抽出し、隣接特徴量差分と結合。
    - **学習:** Bowel/ExtravasationでPositiveサンプルをUpsampling。画像レベルラベルの再学習（stage1予測のmax logitを新ラベルに）。
    - **スタッキング:** 各モデルの予測値を入力とし、Metricを直接最適化するMLPを学習。

